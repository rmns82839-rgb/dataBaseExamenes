<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorizado Lab - Inicio üèçÔ∏è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Paleta de Colores: #333 (Negro Motorizado), #FFC107 (Amarillo de Seguridad), #F4F4F9 (Fondo claro) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: #f4f4f9;
        }
        #container {
            width: 100%;
            max-width: 900px; 
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); 
            box-sizing: border-box;
            border-top: 5px solid #FFC107; 
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        h2 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 25px;
            color: #555;
        }
        
        /* Bot√≥n de Portal */
        .portal-button {
            background-color: #333;
            color: #FFC107;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: block;
            width: 100%;
            margin-bottom: 20px;
            transition: background-color 0.2s;
            text-decoration: none;
            text-align: center;
        }
        .portal-button:hover {
            background-color: #555;
        }
        /* Fin Bot√≥n Portal */

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        input[type="file"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            max-width: 400px;
        }
        button {
            background-color: #FFC107;
            color: #333;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #e0a800;
        }
        #status {
            text-align: center;
            margin-top: 15px;
            color: #007bff;
            font-weight: bold;
        }
        #outputList {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .company-item {
            border: 2px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
        }
        .company-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #FFC107;
            padding-bottom: 5px;
        }
        .patient-list {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .patient-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #007bff;
        }
        .patient-name {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .request-list {
            list-style: none;
            padding-left: 15px;
            margin-top: 5px;
            border-left: 2px dashed #ccc;
        }
        .request-item {
            margin-bottom: 8px;
        }
        .request-header {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        .exam-list {
            list-style: disc;
            font-size: 0.9em;
            color: #666;
            padding-left: 20px;
        }
        .no-exams {
            font-style: italic;
            color: #999;
            margin-left: 15px;
            font-size: 0.9em;
        }
        @media (max-width: 600px) {
            .input-group {
                padding: 15px;
            }
            input[type="file"] {
                max-width: 100%;
            }
            .company-name {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        
        <a href="https://rmns82839-rgb.github.io/portal-de-toma-de-muestras/" class="portal-button" target="_blank">
            Volver al Portal Principal
        </a>
        
        <h1>Motorizado Lab üß™</h1>
        <h2>Procesamiento de Archivo CSV de Ruta</h2>

        <div class="input-group">
            <input type="file" id="csvFile" accept=".csv" required>
            <button onclick="processCSV()">Cargar y Procesar Ruta</button>
            <button onclick="window.location.href='guia_examenes.html'">Ver Gu√≠a de Toma de Muestras</button>
        </div>

        <p id="status">Esperando archivo CSV...</p>

        <ul id="outputList">
            </ul>
    </div>

    <script>
        let processedData = [];

        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            const statusElement = document.getElementById('status');
            
            if (!file) {
                statusElement.textContent = 'Por favor, selecciona un archivo CSV.';
                return;
            }

            statusElement.textContent = 'Procesando archivo...';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                delimiter: ',',
                complete: function(results) {
                    const data = results.data;
                    const totalRowsProcessed = data.length;
                    
                    if (data.length === 0) {
                        statusElement.textContent = 'El archivo est√° vac√≠o o no se pudieron leer los datos.';
                        return;
                    }
                    
                    const COL_COMPANY = 'Tipo cliente';
                    const COL_PATIENT_NAME = 'Nombre Paciente';
                    const COL_REQUEST_ID = 'N¬∞ Solicitud';
                    const COL_EXAMS = 'Examenes solicitados';
                    const COL_DOC = 'N¬∞ Documento';

                    const groupedData = {};
                    const uniqueExams = new Set();
                    
                    data.forEach(row => {
                        const company = row[COL_COMPANY] ? row[COL_COMPANY].trim() : 'SIN COMPA√ë√çA';
                        const patientKey = `${row[COL_PATIENT_NAME]}-${row[COL_DOC]}`.trim();
                        const requestId = row[COL_REQUEST_ID] ? row[COL_REQUEST_ID].trim() : 'SIN SOLICITUD';
                        
                        const examsStr = row[COL_EXAMS] || '';
                        
                        // üü¢ CORRECCI√ìN CLAVE: MANTENER C√ìDIGOS Y TEXTO COMPLETO
                        const exams = examsStr.split(/[\/\/|;]/) 
                            .map(exam => exam.trim().replace(/\s{2,}/g, ' ')) // Limpia espacios extra, pero mantiene c√≥digos
                            .filter(exam => exam.length > 2);

                        // ‚ö†Ô∏è GUARDA LA LISTA √öNICA DE EX√ÅMENES (CON C√ìDIGO)
                        exams.forEach(exam => uniqueExams.add(exam));
                        
                        if (!groupedData[company]) {
                            groupedData[company] = {};
                        }
                        
                        if (!groupedData[company][patientKey]) {
                            groupedData[company][patientKey] = {
                                name: row[COL_PATIENT_NAME] ? row[COL_PATIENT_NAME].trim() : 'N/A',
                                document: row[COL_DOC] ? row[COL_DOC].trim() : 'N/A',
                                requests: {}
                            };
                        }
                        
                        if (!groupedData[company][patientKey].requests[requestId]) {
                            groupedData[company][patientKey].requests[requestId] = {
                                id: requestId,
                                exams: exams
                            };
                        } else {
                            exams.forEach(exam => {
                                if (!groupedData[company][patientKey].requests[requestId].exams.includes(exam)) {
                                    groupedData[company][patientKey].requests[requestId].exams.push(exam);
                                }
                            });
                        }
                    });

                    // *** PUNTO CLAVE: GUARDAR CSV Y DATA PROCESADA EN LOCALSTORAGE ***
                    localStorage.setItem('csv_unique_exams', JSON.stringify(Array.from(uniqueExams).sort()));
                    localStorage.setItem('csv_processed_data', JSON.stringify(groupedData));
                    
                    renderOutput(groupedData, totalRowsProcessed);
                },
                error: function(error) {
                    statusElement.textContent = `Error al parsear el archivo: ${error.message}`;
                    console.error('PapaParse error:', error);
                }
            });
        }

        // Funci√≥n para renderizar el output
        function renderOutput(groupedData, totalRowsProcessed) {
            const outputList = document.getElementById('outputList');
            const statusElement = document.getElementById('status');
            outputList.innerHTML = '';
            
            const companyNames = Object.keys(groupedData);
            const sortedCompanies = companyNames.sort();
            let totalPatients = 0;

            if (sortedCompanies.length === 0) {
                 statusElement.textContent = 'Proceso finalizado, pero no se encontraron datos v√°lidos.';
                 return;
            }

            sortedCompanies.forEach(companyName => {
                const companyData = groupedData[companyName];
                const patientKeys = Object.keys(companyData);
                totalPatients += patientKeys.length;

                const companyListItem = document.createElement('li');
                companyListItem.className = 'company-item';

                const companyNameHeader = document.createElement('h3');
                companyNameHeader.className = 'company-name';
                companyNameHeader.textContent = `${companyName} (${patientKeys.length} Pacientes)`;
                companyListItem.appendChild(companyNameHeader);

                const patientList = document.createElement('ul');
                patientList.className = 'patient-list';

                const sortedPatientKeys = patientKeys.sort((a, b) => companyData[a].name.localeCompare(companyData[b].name));
                
                sortedPatientKeys.forEach(patientKey => {
                    const patientData = companyData[patientKey];
                    const patientListItem = document.createElement('li');
                    patientListItem.className = 'patient-item';

                    const patientNameHeader = document.createElement('p');
                    patientNameHeader.className = 'patient-name';
                    patientNameHeader.textContent = `${patientData.name} (CC: ${patientData.document})`;
                    patientListItem.appendChild(patientNameHeader);

                    const requestKeys = Object.keys(patientData.requests);
                    
                    requestKeys.forEach(requestKey => {
                        const req = patientData.requests[requestKey];
                        const reqItem = document.createElement('div');
                        reqItem.className = 'request-item';

                        const reqHeader = document.createElement('p');
                        reqHeader.className = 'request-header';
                        reqHeader.textContent = `Solicitud N¬∞: ${req.id}`;
                        reqItem.appendChild(reqHeader);

                        if (req.exams && req.exams.length > 0) {
                            const examList = document.createElement('ul');
                            examList.className = 'exam-list';
                            req.exams.forEach(exam => {
                                const examItem = document.createElement('li');
                                examItem.textContent = exam;
                                examList.appendChild(examItem);
                            });
                            reqItem.appendChild(examList);
                        } else {
                            const noExamsMsg = document.createElement('p');
                            noExamsMsg.className = 'no-exams';
                            noExamsMsg.textContent = '‚Äî No se registraron ex√°menes en esta solicitud.';
                            reqItem.appendChild(noExamsMsg);
                        }
                        
                        patientListItem.appendChild(reqItem);
                    });

                    patientList.appendChild(patientListItem);
                });

                companyListItem.appendChild(patientList);
                outputList.appendChild(companyListItem);
            });

            if (totalRowsProcessed !== 'anteriormente') {
                statusElement.textContent = `Proceso finalizado. Se procesaron ${totalRowsProcessed} filas, encontrando ${totalPatients} pacientes agrupados en ${sortedCompanies.length} compa√±√≠as.`;
            }
        }
        
        // Cargar datos de localStorage si existen al iniciar la app
        document.addEventListener('DOMContentLoaded', () => {
            const statusElement = document.getElementById('status');
            const storedData = localStorage.getItem('csv_processed_data');
            
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                renderOutput(parsedData, 'anteriormente'); 
                statusElement.textContent = 'Datos de la √∫ltima ruta cargados. Procesa un nuevo CSV para actualizar.';
            }
        });
    </script>
</body>
</html>
