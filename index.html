<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorizado Lab - Inicio üèçÔ∏è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Paleta de Colores: #333 (Negro Motorizado), #FFC107 (Amarillo de Seguridad), #F4F4F9 (Fondo claro) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: #f4f4f9;
        }
        #container {
            width: 100%;
            max-width: 900px; 
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); 
            box-sizing: border-box;
            border-top: 5px solid #FFC107; 
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        #fileInput {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #processButton {
            background-color: #FFC107; 
            color: #333;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: block;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #processButton:hover {
            background-color: #ffdb6e;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9f7ff;
            color: #1a4f78;
            border-left: 5px solid #1a4f78;
            font-weight: bold;
        }

        /* Enlace de Gu√≠a */
        .guide-link {
            display: block;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background-color: #333;
            color: #FFC107;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .guide-link:hover {
            background-color: #555;
        }

        /* Estilos de Salida */
        #outputList {
            list-style: none;
            padding: 0;
            margin-top: 30px;
        }
        .company-list-item {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .company-header {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .patient-list {
            list-style: none;
            padding: 0;
        }
        .patient-list-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
        }
        .patient-list-item:last-child {
            border-bottom: none;
        }
        .patient-info {
            font-weight: bold;
            color: #1a4f78;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .patient-info .req-num {
            font-size: 0.8em;
            background-color: #FFC107;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: normal;
        }
        .patient-details {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
        }
        .exam-request {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #ffffff;
        }
        .exam-request h3 {
            margin-top: 0;
            font-size: 1em;
            color: #dc3545;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .exam-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .exam-list li {
            padding: 5px 0;
            font-size: 0.9em;
            border-bottom: 1px dotted #f0f0f0;
        }
        .exam-list li:last-child {
            border-bottom: none;
        }
        .no-exams {
            font-style: italic;
            color: #888;
        }
        .exam-name {
            font-weight: 500;
            color: #333;
        }
        .exam-tube {
            font-weight: bold;
            color: #28a745;
            margin-left: 5px;
            background-color: #e6ffed;
            padding: 1px 5px;
            border-radius: 3px;
        }
        .exam-instructions {
            font-style: italic;
            color: #007bff;
            margin-left: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .patient-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .patient-info .req-num {
                margin-top: 5px;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        
        <a href="guia_examenes.html" class="guide-link">
            Ver Gu√≠a R√°pida de Ex√°menes y Clasificaci√≥n üß™
        </a>

        <h1>Carga y Procesamiento de Ruta CSV üèçÔ∏è</h1>
        
        <input type="file" id="fileInput" accept=".csv">
        <button id="processButton" onclick="handleFile()">Procesar Archivo CSV</button>
        
        <div id="status">Esperando la carga del archivo CSV...</div>

        <h2>Resultados Agrupados por Compa√±√≠a üìã</h2>
        <ul id="outputList">
            <p style="text-align: center; color: #888;">Aqu√≠ se mostrar√° la informaci√≥n de la ruta despu√©s del procesamiento.</p>
        </ul>

    </div>

    <script>
        // Endpoint (debe coincidir con tu servidor Render)
        const EXAMS_CLASSIFY_URL = 'https://motorizado-lab-backend.onrender.com/api/exams/classify';
        const EXAMS_UNIQUE_URL = 'https://motorizado-lab-backend.onrender.com/api/exams/unique';
        
        let classificationCache = {}; 
        
        // Funci√≥n para cargar la clasificaci√≥n de MongoDB al inicio
        async function loadClassificationCache() {
            try {
                // Usamos el endpoint que trae todas las clasificaciones para el cach√©
                const response = await fetch('https://motorizado-lab-backend.onrender.com/api/exams/classification/all');
                if (!response.ok) throw new Error("Error al cargar clasificaciones.");
                
                const classificationsArray = await response.json();
                
                // Convertir el array a un mapa de acceso r√°pido: { exam_name: { tube, instructions } }
                classificationCache = classificationsArray.reduce((acc, item) => {
                    acc[item.exam_name] = { tube: item.tube, instructions: item.instructions };
                    return acc;
                }, {});

            } catch (error) {
                console.error("Fallo al cargar clasificaci√≥n:", error);
                // Si falla, el cach√© queda vac√≠o, pero la app sigue funcionando.
            }
        }

        // Cargar el cach√© de clasificaciones al inicio
        document.addEventListener('DOMContentLoaded', loadClassificationCache);


        function handleFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusElement = document.getElementById('status');

            if (!file) {
                statusElement.textContent = '‚ùå Por favor, selecciona un archivo CSV primero.';
                return;
            }

            statusElement.textContent = 'Procesando archivo...';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "ISO-8859-1", // Generalmente necesario para archivos de Excel en espa√±ol
                complete: async function(results) {
                    await processData(results.data);
                },
                error: function(error) {
                    statusElement.textContent = `‚ùå Error al parsear el archivo: ${error.message}`;
                    console.error('PapaParse Error:', error);
                }
            });
        }
        
        function cleanExamName(name) {
             // Elimina el c√≥digo de examen y espacios extra/saltos de l√≠nea.
             // (Ej. "902210 HEMOGRAMA IV" -> "HEMOGRAMA IV")
             return name.replace(/^\s*\d+\s+/, '').trim();
        }

        function extractCodeAndName(rawExam) {
            const trimmed = rawExam.trim();
            const match = trimmed.match(/^(\d+)\s+(.+)/);
            if (match) {
                // Retorna un objeto con el c√≥digo y el nombre limpio
                return {
                    code: match[1], 
                    name: cleanExamName(match[0])
                };
            }
            // Si no tiene c√≥digo al inicio, retorna el texto completo como nombre.
            return {
                code: 'N/A', 
                name: cleanExamName(trimmed) 
            };
        }


        async function processData(data) {
            const statusElement = document.getElementById('status');
            const groupedData = {};
            const uniqueExamsForDB = new Map(); // Usamos Map para asegurar unicidad y guardar el c√≥digo

            data.forEach(row => {
                // Asumiendo que las columnas son: 'Tipo cliente', 'Nombre Paciente', 'Examenes solicitados', 'N¬∞ Solicitud'
                const company = row['Tipo cliente'] ? row['Tipo cliente'].trim() : 'Sin Compa√±√≠a';
                const patientName = row['Nombre Paciente'] ? row['Nombre Paciente'].trim() : 'Sin Nombre';
                const exams = row['Examenes solicitados'] ? row['Examenes solicitados'].trim() : '';
                const solicitationId = row['N¬∞ Solicitud'] ? row['N¬∞ Solicitud'].trim() : 'N/A';
                const fullAddress = row['Direccion y Telefono del paciente'] || 'No disponible';

                if (!groupedData[company]) {
                    groupedData[company] = [];
                }

                const patientKey = `${patientName} | ${solicitationId}`;
                let patientEntry = groupedData[company].find(p => p.key === patientKey);

                if (!patientEntry) {
                    patientEntry = {
                        key: patientKey,
                        name: patientName,
                        solicitationId: solicitationId,
                        address: fullAddress,
                        requests: [] 
                    };
                    groupedData[company].push(patientEntry);
                }
                
                // Dividir y limpiar los ex√°menes
                const rawExams = exams.split('//').map(e => e.trim()).filter(e => e);
                
                const processedExams = rawExams.map(raw => {
                    const { code, name } = extractCodeAndName(raw);
                    
                    // 1. Guardar examen en la lista maestra (solo si no existe)
                    if (!uniqueExamsForDB.has(name)) {
                        uniqueExamsForDB.set(name, { exam_code: code, exam_name: name });
                    }
                    
                    // 2. Obtener clasificaci√≥n desde el cach√© local (cargado de MongoDB)
                    const classification = classificationCache[name];
                    
                    return {
                        raw_name: raw, // Nombre original
                        name: name, // Nombre limpio (sin c√≥digo)
                        code: code, // C√≥digo extra√≠do
                        tube: classification ? classification.tube : 'No Clasificado',
                        instructions: classification ? classification.instructions : ''
                    };
                });
                
                patientEntry.requests.push({
                    exams: processedExams
                });
                
            });
            
            // 2. Guardar lista maestra en MongoDB (usando bulkWrite)
            await saveUniqueExamsToDB([...uniqueExamsForDB.values()]);
            
            // 3. Renderizar resultados
            renderOutput(groupedData, data.length);
        }
        
        // üÜï Funci√≥n para guardar los ex√°menes √∫nicos en el backend (bulk operation)
        async function saveUniqueExamsToDB(uniqueExams) {
             const statusElement = document.getElementById('status');
             
             if (uniqueExams.length === 0) return;
             
             statusElement.textContent = `Guardando ${uniqueExams.length} ex√°menes √∫nicos en la base de datos...`;

             try {
                const response = await fetch(EXAMS_UNIQUE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uniqueExams)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log("Guardado de lista maestra exitoso:", result);

            } catch (error) {
                console.error("Error al guardar lista maestra:", error);
                statusElement.textContent = '‚ùå Error al guardar la lista maestra de ex√°menes √∫nicos en MongoDB.';
            }
        }


        function renderOutput(groupedData, totalRowsProcessed) {
            const outputList = document.getElementById('outputList');
            const statusElement = document.getElementById('status');
            outputList.innerHTML = '';
            let totalPatients = 0;

            const sortedCompanies = Object.keys(groupedData).sort();

            sortedCompanies.forEach(company => {
                const companyListItem = document.createElement('li');
                companyListItem.className = 'company-list-item';
                
                const header = document.createElement('div');
                header.className = 'company-header';
                header.textContent = company;
                companyListItem.appendChild(header);

                const patientList = document.createElement('ul');
                patientList.className = 'patient-list';

                const patients = groupedData[company];
                totalPatients += patients.length;

                patients.sort((a, b) => a.name.localeCompare(b.name));

                patients.forEach(patient => {
                    const patientListItem = document.createElement('li');
                    patientListItem.className = 'patient-list-item';

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'patient-info';
                    infoDiv.innerHTML = `
                        ${patient.name}
                        <span class="req-num">Solicitud N¬∞: ${patient.solicitationId}</span>
                    `;
                    patientListItem.appendChild(infoDiv);

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'patient-details';
                    detailsDiv.textContent = `Direcci√≥n: ${patient.address}`;
                    patientListItem.appendChild(detailsDiv);

                    patient.requests.forEach(request => {
                        const reqItem = document.createElement('div');
                        reqItem.className = 'exam-request';
                        
                        reqItem.innerHTML = `<h3>EX√ÅMENES SOLICITADOS:</h3>`;
                        
                        const examList = document.createElement('ul');
                        examList.className = 'exam-list';
                        
                        if (request.exams.length > 0) {
                            request.exams.forEach(exam => {
                                const listItem = document.createElement('li');
                                listItem.innerHTML = `
                                    <span class="exam-name">(${exam.code}) ${exam.name}</span>
                                    - Muestra: <span class="exam-tube">${exam.tube}</span>
                                    ${exam.instructions ? `<span class="exam-instructions">(Instrucci√≥n: ${exam.instructions})</span>` : ''}
                                `;
                                examList.appendChild(listItem);
                            });
                            reqItem.appendChild(examList);
                        } else {
                            const noExamsMsg = document.createElement('p');
                            noExamsMsg.className = 'no-exams';
                            noExamsMsg.textContent = '‚Äî No se registraron ex√°menes en esta solicitud.';
                            reqItem.appendChild(noExamsMsg);
                        }
                        
                        patientListItem.appendChild(reqItem);
                    });

                    patientList.appendChild(patientListItem);
                });

                companyListItem.appendChild(patientList);
                outputList.appendChild(companyListItem);
            });

            if (totalRowsProcessed !== 'anteriormente') {
                statusElement.textContent = `Proceso finalizado. Se procesaron ${totalRowsProcessed} filas, encontrando ${totalPatients} pacientes agrupados en ${sortedCompanies.length} compa√±√≠as.`;
            }
            
            // Guardar datos en localStorage (opcional)
            localStorage.setItem('csv_processed_data', JSON.stringify(groupedData));
        }
        
        // Cargar datos de localStorage si existen al iniciar la app
        document.addEventListener('DOMContentLoaded', () => {
            const statusElement = document.getElementById('status');
            const storedData = localStorage.getItem('csv_processed_data');
            
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                renderOutput(parsedData, 'anteriormente'); 
                statusElement.textContent = 'Datos de la √∫ltima ruta cargados. Procesa un nuevo CSV para actualizar.';
            }
        });
    </script>
</body>
</html>
