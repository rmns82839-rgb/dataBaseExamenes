<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorizado Lab - Inicio üèçÔ∏è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Paleta de Colores: #333 (Negro Motorizado), #FFC107 (Amarillo de Seguridad), #F4F4F9 (Fondo claro) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: #f4f4f9;
        }
        #container {
            width: 100%;
            max-width: 900px; 
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); 
            box-sizing: border-box;
            border-top: 5px solid #FFC107; 
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }

        /* --- Input y Bot√≥n --- */
        #input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        #fileInput {
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        #processButton {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #processButton:hover {
            background-color: #FFC107;
            color: #333;
        }

        #status {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        
        /* --- Contenedor de Resultados --- */
        #outputList {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }

        /* Grupo de Compa√±√≠a (Nivel 1: Acorde√≥n) */
        .company-group {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .company-header {
            background-color: #FFC107;
            color: #333;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-header span:first-child {
            flex-grow: 1;
        }

        .company-header .patient-count {
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            font-size: 0.9em;
        }

        /* Contenido de Pacientes */
        .patient-list {
            padding: 0;
            margin: 0;
            list-style: none;
            background-color: #f9f9f9;
            /* Acorde√≥n */
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .company-group.active .patient-list {
            max-height: 2000px; /* Suficiente para expandir */
            transition: max-height 0.5s ease-in;
        }

        .patient-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .patient-item:last-child {
            border-bottom: none;
        }

        .patient-info {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .patient-info span {
            font-weight: normal;
            color: #555;
            margin-left: 5px;
        }

        /* Ex√°menes */
        .request-item {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 8px;
            border: 1px solid #ddd;
        }

        .request-header {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .exam-list {
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0;
            font-size: 0.9em;
            color: #666;
        }

        .exam-item {
            margin-left: 15px;
            padding: 2px 0;
            border-bottom: 1px dotted #eee;
        }

        .exam-item:last-child {
            border-bottom: none;
        }
        
        .no-exams {
            color: #e74c3c;
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* Media Queries para Responsividad */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            #container {
                padding: 15px;
            }
            h1 {
                font-size: 1.4em;
            }
            .company-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .company-header .patient-count {
                margin-top: 5px;
            }
            .patient-info {
                font-size: 0.9em;
            }
            .request-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Motorizado Lab üèçÔ∏è</h1>
        <h2>Ruta de Ex√°menes</h2>

        <div id="input-area">
            <input type="file" id="fileInput" accept=".csv" title="Cargar archivo CSV de la ruta">
            <button id="processButton">Procesar CSV</button>
        </div>

        <p id="status">Cargue un archivo CSV con la ruta para comenzar.</p>

        <ul id="outputList">
            </ul>
    </div>

    <script>
        // URL del backend 
        const BACKEND_URL = '/api/exams/unique'; 
        
        document.getElementById('processButton').addEventListener('click', () => {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                processCSV(file);
            } else {
                document.getElementById('status').textContent = 'Por favor, selecciona un archivo CSV.';
            }
        });

        // 1. Manejar el click en el encabezado de la compa√±√≠a (Acorde√≥n)
        document.getElementById('outputList').addEventListener('click', (e) => {
            const header = e.target.closest('.company-header');
            if (header) {
                const group = header.closest('.company-group');
                group.classList.toggle('active');
            }
        });

        // 2. Funci√≥n para parsear y procesar el CSV
        function processCSV(file) {
            document.getElementById('status').textContent = 'Procesando archivo...';
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const parsedData = groupDataByCompanyAndPatient(results.data);
                    
                    // ‚ö†Ô∏è Paso adicional: Extraer todos los ex√°menes √∫nicos y enviarlos al backend (Incluyendo el c√≥digo)
                    const uniqueExams = extractUniqueExams(parsedData);
                    saveUniqueExamsToDB(uniqueExams); 

                    renderOutput(parsedData, results.data.length);
                    
                    localStorage.setItem('csv_processed_data', JSON.stringify(parsedData)); 
                },
                error: function (error) {
                    console.error("Error al parsear CSV:", error);
                    document.getElementById('status').textContent = 'Error al leer el archivo CSV.';
                }
            });
        }

        // 3. Agrupar los datos del CSV por Compa√±√≠a y Paciente (sin cambios aqu√≠)
        function groupDataByCompanyAndPatient(data) {
            const companies = {};
            let totalPatients = 0;

            data.forEach(row => {
                const companyName = row['Tipo cliente'] || 'Sin Compa√±√≠a';
                const patientName = row['Nombre Paciente'] || 'Desconocido';
                const docId = row['N¬∞ Documento'] || 'Sin ID';
                const requestNumber = row['N¬∞ Solicitud'] || 'Sin Solicitud';
                const addressPhone = row['Direccion y Telefono del paciente'] || 'Sin Direcci√≥n/Tel√©fono';
                const requestedExamsRaw = row['Examenes solicitados'] || '';
                const appointmentTime = row['Hora cita'] || 'N/A';
                
                // Dividir y limpiar los ex√°menes. El separador parece ser '//'
                const exams = requestedExamsRaw.split('//').map(exam => exam.trim()).filter(exam => exam.length > 0);

                if (!companies[companyName]) {
                    companies[companyName] = {
                        name: companyName,
                        patients: {},
                        patientList: []
                    };
                }

                const patientKey = `${docId}-${patientName}`;

                if (!companies[companyName].patients[patientKey]) {
                    companies[companyName].patients[patientKey] = {
                        name: patientName,
                        docId: docId,
                        addressPhone: addressPhone,
                        requests: []
                    };
                    companies[companyName].patientList.push(companies[companyName].patients[patientKey]);
                    totalPatients++;
                }
                
                // A√±adir la solicitud al paciente 
                companies[companyName].patients[patientKey].requests.push({
                    requestNumber: requestNumber,
                    appointmentTime: appointmentTime,
                    exams: exams
                });
            });

            const sortedCompanies = Object.values(companies).sort((a, b) => a.name.localeCompare(b.name));
            
            return { sortedCompanies, totalPatients };
        }
        
        // 4. Extraer los ex√°menes √∫nicos para la lista maestra (¬°L√ìGICA DE C√ìDIGO A√ëADIDA!)
        function extractUniqueExams(parsedData) {
            const uniqueExams = new Map();
            // Regex para capturar el c√≥digo (6 d√≠gitos) y el nombre restante
            const examRegex = /^(\d{6})\s*(.*)/; 

            parsedData.sortedCompanies.forEach(company => {
                company.patientList.forEach(patient => {
                    patient.requests.forEach(request => {
                        request.exams.forEach(examRaw => {
                            const match = examRaw.match(examRegex);
                            let examCode = 'N/A';
                            let examName = examRaw.trim(); 

                            if (match) {
                                // Si hay match, el primer grupo es el c√≥digo, el segundo el nombre restante
                                examCode = match[1].trim(); 
                                // Usar el nombre limpio. Si no hay nada despu√©s del c√≥digo, se usa el raw original.
                                examName = match[2] ? match[2].trim() : examName; 
                            }
                            
                            // Usamos el nombre limpio para la unicidad, y garantizamos el par (code, name)
                            if (!uniqueExams.has(examName)) {
                                uniqueExams.set(examName, { 
                                    exam_code: examCode, 
                                    exam_name: examName 
                                });
                            }
                        });
                    });
                });
            });

            return Array.from(uniqueExams.values());
        }

        // 5. Enviar la lista de ex√°menes √∫nicos al servidor
        async function saveUniqueExamsToDB(uniqueExams) {
            try {
                const statusElement = document.getElementById('status');
                statusElement.textContent = `Procesando ex√°menes √∫nicos (${uniqueExams.length} encontrados)...`;
                
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(uniqueExams),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Respuesta del servidor al guardar ex√°menes:', result);
                statusElement.textContent = `Proceso finalizado. Ex√°menes √∫nicos guardados.`;

            } catch (error) {
                console.error("Error al guardar ex√°menes √∫nicos en DB:", error);
                document.getElementById('status').textContent = `Error al guardar ex√°menes √∫nicos. Revisa la consola.`;
            }
        }
        
        // 6. Renderizar la salida de datos (sin cambios relevantes)
        function renderOutput(parsedData, totalRowsProcessed) {
            const outputList = document.getElementById('outputList');
            const statusElement = document.getElementById('status');
            outputList.innerHTML = '';
            
            const { sortedCompanies, totalPatients } = parsedData;

            if (sortedCompanies.length === 0) {
                 statusElement.textContent = `Proceso finalizado. No se encontraron datos v√°lidos.`;
                 return;
            }

            sortedCompanies.forEach(company => {
                const companyListItem = document.createElement('li');
                companyListItem.className = 'company-group';

                // Encabezado de la Compa√±√≠a
                const companyHeader = document.createElement('div');
                companyHeader.className = 'company-header';
                companyHeader.innerHTML = `
                    <span>${company.name}</span>
                    <span class="patient-count">${company.patientList.length} Paciente(s)</span>
                `;
                companyListItem.appendChild(companyHeader);

                // Lista de Pacientes
                const patientList = document.createElement('ul');
                patientList.className = 'patient-list';
                
                company.patientList.forEach(patient => {
                    const patientListItem = document.createElement('li');
                    patientListItem.className = 'patient-item';

                    // Informaci√≥n del Paciente
                    const patientInfo = document.createElement('div');
                    patientInfo.className = 'patient-info';
                    patientInfo.innerHTML = `
                        Paciente: <span>${patient.name} (${patient.docId})</span><br>
                        Direcci√≥n/Tel√©fono: <span>${patient.addressPhone}</span>
                    `;
                    patientListItem.appendChild(patientInfo);

                    // Solicitudes del Paciente
                    patient.requests.forEach(request => {
                        const reqItem = document.createElement('div');
                        reqItem.className = 'request-item';
                        
                        const reqHeader = document.createElement('div');
                        reqHeader.className = 'request-header';
                        reqHeader.innerHTML = `
                            <span>N¬∞ Solicitud: <strong>${request.requestNumber}</strong></span>
                            <span>Hora Cita: <strong>${request.appointmentTime}</strong></span>
                        `;
                        reqItem.appendChild(reqHeader);

                        if (request.exams && request.exams.length > 0) {
                            const examList = document.createElement('ul');
                            examList.className = 'exam-list';
                            request.exams.forEach(exam => {
                                const examItem = document.createElement('li');
                                examItem.className = 'exam-item';
                                examItem.textContent = exam;
                                examList.appendChild(examItem);
                            });
                            reqItem.appendChild(examList);
                        } else {
                            const noExamsMsg = document.createElement('p');
                            noExamsMsg.className = 'no-exams';
                            noExamsMsg.textContent = '‚Äî No se registraron ex√°menes en esta solicitud.';
                            reqItem.appendChild(noExamsMsg);
                        }
                        
                        patientListItem.appendChild(reqItem);
                    });

                    patientList.appendChild(patientListItem);
                });

                companyListItem.appendChild(patientList);
                outputList.appendChild(companyListItem);
            });

            if (totalRowsProcessed !== 'anteriormente') {
                statusElement.textContent = `Proceso finalizado. Se procesaron ${totalRowsProcessed} filas, encontrando ${totalPatients} pacientes agrupados en ${sortedCompanies.length} compa√±√≠as.`;
            }
        }
        
        // Cargar datos de localStorage si existen al iniciar la app
        document.addEventListener('DOMContentLoaded', () => {
            const statusElement = document.getElementById('status');
            const storedData = localStorage.getItem('csv_processed_data');
            
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                renderOutput(parsedData, 'anteriormente'); 
                statusElement.textContent = 'Datos de la √∫ltima ruta cargados. Procesa un nuevo CSV para actualizar.';
            }
        });
    </script>
</body>
</html>
