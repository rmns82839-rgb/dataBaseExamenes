<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorizado Lab - Gu√≠a R√°pida üß™</title>
    <style>
        /* --- ESTILOS GENERALES Y PALETA --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0; 
            padding: 20px 10px; 
            background-color: #f4f4f9;
        }
        #container {
            width: 100%;
            max-width: 900px; 
            margin: auto;
            background: white;
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            margin-top: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.6em;
            text-transform: uppercase;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        /* --- ESTILOS DE ACORDE√ìN / CONTENEDORES --- */
        .tube-group {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .tube-header {
            background-color: #333;
            color: white;
            padding: 12px 15px;
            margin: 0;
            cursor: pointer;
            border-left: 5px solid #FFC107;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        .tube-header span:last-child {
            font-size: 0.8em;
            font-weight: normal;
            color: #ccc;
        }
        .tube-header::after {
            content: '+';
            font-size: 1.5em;
            transition: transform 0.3s;
        }
        .tube-group.active > .tube-header::after {
            content: '‚àí';
        }
        .tube-content {
            padding: 0;
            margin: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s;
            background-color: #fcfcfc;
        }
        .tube-group.active > .tube-content {
            max-height: 5000px; /* Suficientemente grande */
            padding: 10px;
        }
        
        /* --- ESTILOS DE ITEM DE EXAMEN (CSV) --- */
        .csv-exam-item {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #ffffff;
            transition: background-color 0.2s;
        }
        .csv-exam-item:hover {
             background-color: #fffacd;
        }
        .csv-exam-item:last-child {
            border-bottom: none;
        }
        .exam-name-display {
            font-weight: bold;
            flex-basis: 30%; 
            min-width: 150px;
            margin-right: 10px;
        }
        .tube-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        .classification-form {
            flex-basis: 60%; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .classification-form select, 
        .classification-form input[type="text"] {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.85em;
        }
        .classification-form select {
            flex-grow: 0.5;
            min-width: 120px;
        }
        .classification-form input[type="text"] {
            flex-grow: 1;
        }
        .save-button {
            background-color: #28a745; 
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .save-button:hover {
            background-color: #218838;
        }
        .save-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* --- ESTILOS DE COLOR DE TUBOS --- */
        .tube-indicator.yellow { background-color: #FFC107; }
        .tube-indicator.lila { background-color: #8e2de2; } 
        .tube-indicator.celeste { background-color: #00b0ff; } 
        .tube-indicator.red { background-color: #dc3545; } 
        .tube-indicator.green { background-color: #28a745; } 
        .tube-indicator.gray { background-color: #6c757d; } 
        .tube-indicator.azul-rey { background-color: #4169e1; } 
        .tube-indicator.perlado { background-color: #c790b5; } 
        .tube-indicator.fecal { background-color: #8B4513; } 
        .tube-indicator.urine { background-color: #ffdead; border: 1px solid #8B4513;} 
        .tube-indicator.saliva { background-color: #f0f8ff; border: 1px solid #333; } 
        .tube-indicator.other { background-color: #333; }
        .tube-indicator.No.Clasificado { background-color: #fff; border: 1px dashed #dc3545; }

        /* Estilos de la gu√≠a est√°tica */
        .guide-exam-item {
             padding: 8px;
             border-bottom: 1px dotted #ccc;
             font-weight: 500;
             font-size: 0.95em;
        }
        .guide-exam-item:last-child {
             border-bottom: none;
        }
        .guide-note {
             font-style: italic;
             font-size: 0.85em;
             color: #666;
             margin-left: 10px;
        }
        
        /* Bot√≥n de Regreso */
        .back-button {
            background-color: #333;
            color: #FFC107;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: block;
            width: 100%;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: #555;
        }


        /* Responsive */
        @media (max-width: 600px) {
            .csv-exam-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .exam-name-display {
                flex-basis: 100%;
                margin-right: 0;
                display: flex;
                align-items: center;
            }
            .classification-form {
                flex-basis: 100%;
                flex-wrap: nowrap;
            }
            .classification-form select, 
            .classification-form input[type="text"] {
                width: auto;
                flex-grow: 1;
            }
            .save-button {
                 padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        
        <button class="back-button" onclick="window.location.href='index.html'">
            ‚¨ÖÔ∏è Regresar a la Carga de Ex√°menes (P√°gina Principal)
        </button>
        
        <h1>Gu√≠a R√°pida de Clasificaci√≥n de Muestras</h1>

        <input type="text" id="searchInput" placeholder="Buscar por C√≥digo o Nombre del Examen..." onkeyup="filterExams()" style="width: 100%; padding: 12px; margin-bottom: 25px; border: 2px solid #333; border-radius: 5px; font-size: 1.1em;">
        
        <p id="saveStatus" style="text-align: center; color: #1a4f78; font-weight: bold; margin-bottom: 20px; background-color: #e9f7ff; padding: 10px; border-radius: 5px;"></p>

        <div id="csvExamsContainer">
            <h2>CLASIFICACI√ìN DE EX√ÅMENES DE RUTA ACTUAL üìù</h2>
            <div id="csvExamsList">
                <p style="text-align: center; color: #555;">Cargando datos...</p>
            </div>
        </div>
        
        <hr style="margin: 30px 0;">

        <div id="examensList">
            <h2>GU√çA R√ÅPIDA DE REFERENCIA DE TUBOS üí°</h2>
            
            <div class="tube-group" id="yellow-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Tubo Amarillo (Gel/Suero)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">GLUCOSA <span class="guide-note">(Requiere ayuno o seg√∫n orden)</span></div>
                    <div class="guide-exam-item">PERFIL LIP√çDICO / COLESTEROL / TRIGLIC√âRIDOS</div>
                    <div class="guide-exam-item">PERFIL HEP√ÅTICO</div>
                    <div class="guide-exam-item">CREATININA / BUN / √ÅCIDO √öRICO</div>
                    <div class="guide-exam-item">HORMONA ESTIMULANTE DEL TIROIDES (TSH) / T4 Libre</div>
                </div>
            </div>
            
            <div class="tube-group" id="lila-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Tubo Lila (EDTA)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">HEMOGRAMA / HEMOGRAMA IV</div>
                    <div class="guide-exam-item">HEMOGLOBINA GLICOSILADA</div>
                    <div class="guide-exam-item">VSG (Velocidad de Sedimentaci√≥n Globular)</div>
                    <div class="guide-exam-item">TIPIFICACI√ìN SANGU√çNEA</div>
                </div>
            </div>
            
            <div class="tube-group" id="celeste-guide-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Tubo Celeste (Citarto)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">TP (Tiempo de Protrombina)</div>
                    <div class="guide-exam-item">TPT (Tiempo de Tromboplastina Parcial)</div>
                    <div class="guide-exam-item">FIBRIN√ìGENO</div>
                </div>
            </div>

             <div class="tube-group" id="azul-rey-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Tubo Azul Rey (Elementos Traza)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">COBRE / ZINC</div>
                    <div class="guide-exam-item">CUALQUIER EXAMEN DE METALES PESADOS</div>
                </div>
            </div>
            
             <div class="tube-group" id="urine-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Orina</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">UROAN√ÅLISIS <span class="guide-note">(Orina simple)</span></div>
                    <div class="guide-exam-item">CULTIVO DE ORINA</div>
                    <div class="guide-exam-item">MICROALBUMINURIA</div>
                </div>
            </div>

             <div class="tube-group" id="fecal-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Heces (Materia Fecal)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">COPROL√ìGICO</div>
                    <div class="guide-exam-item">SANGRE OCULTA EN MATERIA FECAL</div>
                </div>
            </div>
            
             <div class="tube-group" id="other-group">
                <h2 class="tube-header" onclick="toggleAccordion(this)">Otros / Especiales (Ej. Rojo, Verde, Gris, Perlado)</h2>
                <div class="tube-content">
                    <div class="guide-exam-item">GLUCOSA POST-CARGA <span class="guide-note">(Requiere tomas seriadas en Gris)</span></div>
                    <div class="guide-exam-item">BNP PEPTIDO NATRIUR√âTICO</div>
                    <div class="guide-exam-item">ANT√çGENO ESPEC√çFICO DE PR√ìSTATA (PSA)</div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // 1. CONFIGURACI√ìN DEL ENDPOINT (¬°VERIFICA ESTA URL!)
        // Debe ser la URL de tu servicio de Render
        const API_BASE_URL = 'https://motorizado-lab-backend.onrender.com/api/classification'; 
        
        let classificationDataCache = {};
        let examsArrayGlobal = []; 

        const tubeOptions = {
            'No Clasificado': 'No Clasificado',
            'Tubo Amarillo (Gel/Suero)': 'yellow',
            'Tubo Lila (EDTA)': 'lila',
            'Tubo Celeste (Citarto)': 'celeste',
            'Tubo Rojo (Sin Aditivo)': 'red',
            'Tubo Verde (Heparina)': 'green',
            'Tubo Gris (Fluoruro)': 'gray',
            'Tubo Azul Rey (Elementos Traza)': 'azul-rey',
            'Tubo Perlado (PPT/STP)': 'perlado',
            'Orina': 'urine',
            'Heces (Materia Fecal)': 'fecal',
            'Saliva': 'saliva',
            'Otro/Especial': 'other'
        };

        // 2. L√ìGICA DE CONEXI√ìN CON EL SERVIDOR RENDER/MONGODB
        
        // Carga las clasificaciones guardadas en MongoDB
        async function getClassificationDataOnline() {
            try {
                const response = await fetch(API_BASE_URL);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const classificationData = await response.json();
                classificationDataCache = classificationData;
                return classificationData;
            } catch (error) {
                console.error("Error al cargar clasificaci√≥n de MongoDB:", error);
                document.getElementById('saveStatus').textContent = '‚ùå Error al cargar datos. ¬øEst√° el servidor Render activo?';
                return {};
            }
        }
        
        // Guarda la clasificaci√≥n en MongoDB
        async function saveClassificationOnline(examKey, tubeValue, instructionsValue) {
            try {
                const button = document.getElementById(`save-btn-${examKey}`);
                if (button) button.disabled = true;

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        exam_name: examKey, 
                        tube: tubeValue,
                        instructions: instructionsValue.trim()
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                // Actualizar cach√© y re-renderizar para que el examen se mueva de contenedor
                classificationDataCache[examKey] = { tube: tubeValue, instructions: instructionsValue.trim() };
                renderGroupedExams(examsArrayGlobal, classificationDataCache);

                document.getElementById('saveStatus').textContent = `‚úÖ Examen "${examKey}" guardado y movido a su contenedor a las ${new Date().toLocaleTimeString()}.`;
                
            } catch (error) {
                console.error("Error al guardar clasificaci√≥n:", error);
                document.getElementById('saveStatus').textContent = '‚ùå Error al guardar datos. Revisa la consola y la URL del servidor.';
            } finally {
                 if (button) button.disabled = false;
            }
        }
        
        function saveClassificationTrigger(examKey) {
            const select = document.getElementById(`select-${examKey}`);
            const input = document.getElementById(`input-${examKey}`);
            
            if (select && input) {
                 saveClassificationOnline(examKey, select.value, input.value);
            }
        }

        // 3. RENDERIZADO DE EX√ÅMENES DEL CSV AGRUPADOS POR TUBO
        
        function renderGroupedExams(examsArray, classificationData) {
            const container = document.getElementById('csvExamsList');
            container.innerHTML = '';
            
            if (examsArray.length === 0) {
                 container.innerHTML = `<p style="color: #dc3545; font-weight: bold; text-align: center;">‚ö†Ô∏è La √∫ltima ruta CSV no conten√≠a ex√°menes v√°lidos.</p>`;
                 return;
            }
            
            const groupedExams = {};
            Object.keys(tubeOptions).forEach(tubeName => groupedExams[tubeName] = []);
            
            examsArray.forEach(exam => {
                const classification = classificationData[exam] || { tube: 'No Clasificado', instructions: '' };
                const tubeKey = classification.tube || 'No Clasificado';
                
                const tubeNameKey = Object.keys(tubeOptions).find(key => tubeOptions[key] === tubeOptions[tubeKey]);

                if (tubeNameKey && groupedExams[tubeNameKey]) {
                    groupedExams[tubeNameKey].push({ 
                        examKey: exam, 
                        tube: classification.tube, 
                        instructions: classification.instructions 
                    });
                }
            });
            
            const sortedTubeKeys = Object.keys(groupedExams).sort((a, b) => {
                if (a === 'No Clasificado') return -1; 
                if (b === 'No Clasificado') return 1;
                return a.localeCompare(b);
            });
            
            sortedTubeKeys.forEach(tubeName => {
                const examsInGroup = groupedExams[tubeName];
                
                if (examsInGroup.length > 0) {
                    const tubeClass = tubeOptions[tubeName]; 
                    const safeTubeId = tubeClass.replace(/[^a-zA-Z0-9]/g, '-');
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'tube-group csv-group';
                    groupDiv.id = `group-${safeTubeId}`;
                    
                    const header = document.createElement('div');
                    header.className = 'tube-header';
                    header.onclick = () => toggleAccordion(header);
                    header.innerHTML = `${tubeName} <span>(${examsInGroup.length} Ex√°menes)</span>`;
                    groupDiv.appendChild(header);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'tube-content';
                    
                    examsInGroup.forEach(examData => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'csv-exam-item';
                        itemDiv.dataset.exam = examData.examKey;

                        const indicator = document.createElement('span');
                        indicator.className = 'tube-indicator ' + tubeOptions[examData.tube];
                        itemDiv.appendChild(indicator);
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'exam-name-display';
                        nameSpan.textContent = examData.examKey;
                        itemDiv.appendChild(nameSpan);

                        const formDiv = document.createElement('div');
                        formDiv.className = 'classification-form';

                        const select = document.createElement('select');
                        select.id = `select-${examData.examKey}`;
                        
                        Object.keys(tubeOptions).forEach(optionName => {
                            const option = document.createElement('option');
                            option.value = optionName;
                            option.textContent = optionName;
                            if (optionName === examData.tube) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                        formDiv.appendChild(select);

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `input-${examData.examKey}`;
                        input.placeholder = 'Instrucci√≥n (e.g., Ayuno, Hielo)';
                        input.value = examData.instructions;
                        formDiv.appendChild(input);
                        
                        const saveBtn = document.createElement('button');
                        saveBtn.id = `save-btn-${examData.examKey}`;
                        saveBtn.className = 'save-button';
                        saveBtn.textContent = 'Guardar';
                        saveBtn.onclick = () => saveClassificationTrigger(examData.examKey);
                        formDiv.appendChild(saveBtn);


                        itemDiv.appendChild(formDiv);
                        contentDiv.appendChild(itemDiv);
                    });

                    groupDiv.appendChild(contentDiv);
                    container.appendChild(groupDiv);
                }
            });
             document.getElementById('saveStatus').textContent = `Lista de ${examsArray.length} ex√°menes cargados. Clasificaci√≥n le√≠da de MongoDB y agrupada.`;
        }

        // Carga la lista de ex√°menes de la ruta desde localStorage y las clasificaciones de MongoDB
        async function loadAndRenderCSVExams() {
            const container = document.getElementById('csvExamsList');
            
            // *** PUNTO CLAVE: CARGAR CSV DE LOCALSTORAGE ***
            const storedExams = localStorage.getItem('csv_unique_exams');
            
            const classificationData = await getClassificationDataOnline();
            
            container.innerHTML = '';
            
            if (!storedExams) {
                container.innerHTML = `<p style="color: #dc3545; font-weight: bold; text-align: center;">‚ö†Ô∏è No hay ex√°menes de ruta guardados. Carga un archivo en la p√°gina principal.</p>`;
                return;
            }

            // Si hay storedExams, se cargan y se usan.
            examsArrayGlobal = JSON.parse(storedExams);
            
            renderGroupedExams(examsArrayGlobal, classificationData);
        }

        // 4. FUNCIONES ADICIONALES
        function toggleAccordion(header) {
            const group = header.closest('.tube-group');
            group.classList.toggle('active');
        }

        function filterExams() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const csvContainer = document.getElementById('csvExamsList');
            const guideContainer = document.getElementById('examensList');
            
            if (searchTerm.length === 0) {
                // Si la b√∫squeda est√° vac√≠a, mostrar todo y colapsar los acordeones.
                [...csvContainer.querySelectorAll('.csv-group'), ...guideContainer.querySelectorAll('.tube-group')].forEach(group => {
                    group.style.display = 'block';
                    group.classList.remove('active');
                    [...group.querySelectorAll('.csv-exam-item'), ...group.querySelectorAll('.guide-exam-item')].forEach(item => item.style.display = 'flex');
                });
                return;
            }
            
            // 1. Filtrar Acordeones de la GU√çA EST√ÅTICA
            guideContainer.querySelectorAll('.tube-group').forEach(group => {
                let foundInGroup = false;
                const items = [...group.querySelectorAll('.guide-exam-item')];

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'block';
                        foundInGroup = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                if (foundInGroup || group.querySelector('.tube-header').textContent.toLowerCase().includes(searchTerm)) {
                    group.style.display = 'block';
                    group.classList.add('active'); 
                } else {
                    group.style.display = 'none';
                }
            });

            // 2. Filtrar Acordeones del CSV (EX√ÅMENES DE RUTA)
             csvContainer.querySelectorAll('.csv-group').forEach(group => {
                let foundInGroup = false;
                const items = [...group.querySelectorAll('.csv-exam-item')];

                items.forEach(item => {
                    const name = item.querySelector('.exam-name-display').textContent.toLowerCase();
                    const instructions = item.querySelector('input[type="text"]').value.toLowerCase();
                    
                    if (name.includes(searchTerm) || instructions.includes(searchTerm)) {
                        item.style.display = 'flex';
                        foundInGroup = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                if (foundInGroup || group.querySelector('.tube-header').textContent.toLowerCase().includes(searchTerm)) {
                    group.style.display = 'block';
                    group.classList.add('active'); 
                } else {
                    group.style.display = 'none';
                }
            });
        }


        // 5. INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', () => {
             // Cargar los ex√°menes del CSV (de localStorage) y las clasificaciones (de MongoDB)
            loadAndRenderCSVExams(); 
            
            // Colapsar gu√≠as est√°ticas al inicio
            document.getElementById('examensList').querySelectorAll('.tube-group').forEach(group => {
                 group.classList.remove('active');
            });
        });

    </script>
</body>
</html>
